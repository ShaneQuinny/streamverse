<div class="title-detail-container">
  <div class="container">
    <!-- Loading State -->
    @if (isLoading) {
      <div class="loading-state">
        <div class="spinner-border text-light" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-white mt-3">Loading title details...</p>
      </div>
    }

    <!-- Error State -->
    @if (errorMessage) {
      <div class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {{ errorMessage }}
      </div>
    }

    <!-- Title Content -->
    @if (title && !isLoading) {
      <!-- Main Content Section -->
      <div class="row mb-5">
        <!-- Left Column: Title Info -->
        <div class="col-lg-8 col-md-7">
          <div class="title-main-info">
            <span class="type-badge">{{ title.type }}</span>
            <h1 class="title-name">{{ title.title }}</h1>
            <div class="title-meta-bar">
              <span class="meta-item">
                <i class="bi bi-calendar3"></i>
                {{ title.release_year }}
              </span>
              <span class="meta-divider">‚Ä¢</span>
              <span class="meta-item">
                <i class="bi bi-clock"></i>
                {{ title.duration_in_mins }}min
              </span>
              <span class="meta-divider">‚Ä¢</span>
              <span class="rating-badge-large">{{ title.rating }}</span>
            </div>
            <div class="title-genres-list">
              @for (genre of title.genres; track genre) {
                <span class="genre-pill">{{ genre }}</span>
              }
            </div>
            <div class="ratings-section">
              <div class="rating-item">
                <i class="bi bi-star-fill text-warning"></i>
                <span class="rating-label">IMDb:</span>
                <span class="rating-value">{{ title.imdb_rating }}/10</span>
              </div>
              <div class="rating-item">
                <span class="tomato-icon">üçÖ</span>
                <span class="rating-label">Rotten Tomatoes:</span>
                <span class="rating-value">{{ title.rotten_tomatoes_score }}%</span>
              </div>
            </div>
            <div class="description-section">
              <h5>Overview</h5>
              <p>{{ title.description }}</p>
            </div>
          </div>
        </div>

        <!-- Right Column: Poster & Where to Watch -->
        <div class="col-lg-4 col-md-5">
          <!-- Poster Section -->
          <div class="poster-section">
            <div class="title-poster-large">
              <div class="poster-image" [style.background]="getPosterUrl(title) ? 'url(' + getPosterUrl(title) + ') center/cover' : 'linear-gradient(135deg, #0093E9 0%, #80D0C7 100%)'">
                @if (!getPosterUrl(title)) {
                  <div class="poster-placeholder-text">
                    <i class="bi" [class]="title.type === 'Movie' ? 'bi-film' : 'bi-tv'"></i>
                    <span>No Poster Available</span>
                  </div>
                }
              </div>
            </div>
          </div>

          <!-- Where to Watch Section -->
          <div class="where-to-watch-section">
            <h5>
              <i class="bi bi-play-btn-fill"></i>
              Where to Watch
            </h5>
            <div class="platforms-grid">
              @for (platform of title.available_on; track platform.platform) {
                <a [href]="platform.url" target="_blank" class="platform-card">
                  <div class="platform-icon">
                    <i class="bi bi-play-circle-fill"></i>
                  </div>
                  <span class="platform-name">{{ platform.platform }}</span>
                  <i class="bi bi-arrow-up-right-circle external-link"></i>
                </a>
              }
              @if (title.available_on.length === 0) {
                <div class="no-platforms">
                  <i class="bi bi-exclamation-circle"></i>
                  <span>Availability info coming soon</span>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Tailored Recommendations Section -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="recommendations-container">
            <h3 class="section-title">
              <i class="bi bi-stars"></i>
              Because you watched {{ title.title }}
            </h3>

            @if (recommendationsLoading) {
              <p class="text-white-50 mb-0">Loading tailored recommendations...</p>
            }
            @else if (recommendationsError) {
              <div class="alert alert-warning py-2 mb-0">
                {{ recommendationsError }}
              </div>
            }
            @else if (recommendedTitles.length > 0) {
              <div class="row g-3">
                @for (rec of recommendedTitles; track rec._id ?? rec.title) {
                  <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="recommendation-card" [routerLink]="['/titles', rec._id]">
                      <div class="rec-title">{{ rec.title }}</div>

                      <div class="rec-meta">
                        <span class="rec-rating">
                          <i class="bi bi-star-fill"></i>
                          {{ rec.imdb_rating }}/10
                        </span>

                        @if (rec.genres?.length) {
                          <span class="rec-genre">
                            {{ rec.genres[0] }}
                          </span>
                        }
                      </div>

                      @if (rec.cast?.length) {
                        <div class="rec-cast">
                          Starring: {{ rec.cast.slice(0, 2).join(', ') }}
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            }
            @else {
              <p class="text-white-50 mb-0">
                No tailored recommendations available yet.
              </p>
            }
          </div>
        </div>
      </div>

      <!-- Reviews Section -->
      <div class="row">
        <div class="col-12">
          <div class="reviews-container">
            <h3 class="section-title">
              <i class="bi bi-chat-square-text"></i>
              User Reviews
            </h3>

            <!-- Review Form -->
            @if (currentUsername) {
              <div class="review-form-card">
                <h5>{{ editingReviewId ? 'Edit Your Review' : 'Write a Review' }}</h5>
                <form [formGroup]="reviewForm" (ngSubmit)="onSubmitReview()">
                  <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" formControlName="username" readonly>
                  </div>
                  
                  <div class="mb-4">
                    <label class="form-label mb-3">Rate this movie</label>
                    <div class="d-flex flex-column align-items-start">
                      <div class="star-rating mb-3">
                        <input type="radio" name="rating" value="1" formControlName="rating"><i></i>
                        <input type="radio" name="rating" value="2" formControlName="rating"><i></i>
                        <input type="radio" name="rating" value="3" formControlName="rating"><i></i>
                        <input type="radio" name="rating" value="4" formControlName="rating"><i></i>
                        <input type="radio" name="rating" value="5" formControlName="rating"><i></i>
                      </div>
                      <div class="rating-text-display">
                        <span class="rating-number">{{ reviewForm.get('rating')?.value || 0 }}</span>
                        <span class="rating-label-text"> out of 5 stars</span>
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Comment</label>
                    <textarea class="form-control" formControlName="comment" rows="4" placeholder="Share your thoughts about this title..."></textarea>
                    @if (reviewForm.get('comment')?.invalid && reviewForm.get('comment')?.touched) {
                      <div class="text-danger mt-1">
                        <small>Comment is required</small>
                      </div>
                    }
                  </div>

                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" [disabled]="reviewForm.invalid">
                      <i class="bi bi-send"></i>
                      {{ editingReviewId ? 'Update Review' : 'Submit Review' }}
                    </button>
                    @if (editingReviewId) {
                      <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
                        <i class="bi bi-x-circle"></i>
                        Cancel
                      </button>
                    }
                  </div>
                </form>
              </div>
            }
            @else {
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Please log in to write a review.
              </div>
            }

            <!-- Reviews List -->
            <div class="reviews-list">
              @if (reviews$ | async; as reviews) {
                @if (reviews.length > 0) {
                  @for (review of reviews; track review._id) {
                    <div class="review-card">
                      <div class="review-header">
                        <div class="reviewer-info">
                          <div class="reviewer-avatar">
                            <i class="bi bi-person-circle"></i>
                          </div>
                          <div>
                            <h6 class="reviewer-name">{{ review.username }}</h6>
                            <div class="review-rating">
                              @for (ratingNum of [1,2,3,4,5]; track ratingNum) {
                                <i class="bi" [class.bi-star-fill]="ratingNum <= review.rating" [class.bi-star]="ratingNum > review.rating">
                                </i>
                              }
                            </div>
                          </div>
                        </div>
                        <div class="review-meta">
                          <div class="review-date">
                            <small class="text-muted">{{ review.date | date:'medium' }}</small>
                          </div>
                          <!-- Edit/Delete buttons for own review or admin -->
                          @if (currentUsername === review.username || isAdmin) {
                            <div class="review-actions mt-2">
                              @if (currentUsername === review.username) {
                                <button (click)="onEditReview(review)" class="btn btn-sm btn-outline-warning me-2">
                                  <i class="bi bi-pencil"></i> Edit
                                </button>
                              }
                              @if (isAdmin) {
                                <button (click)="onDeleteReview(review._id)" class="btn btn-sm btn-outline-danger">
                                  <i class="bi bi-trash"></i> Delete
                                </button>
                              }
                            </div>
                          }
                        </div>
                      </div>
                      <div class="review-body">
                        <p>{{ review.comment }}</p>
                      </div>
                    </div>
                  }
                }
                @else {
                  <div class="no-reviews">
                    <i class="bi bi-chat-square-dots"></i>
                    <p>No reviews yet. Be the first to review this title!</p>
                  </div>
                }
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Title Actions (Edit/Delete) -->
      @if (currentUsername) {
        <div class="row mt-4">
          <div class="col-12">
            <div class="title-actions">
              <a [routerLink]="['/titles', title._id, 'edit']" class="btn btn-warning me-2">
                <i class="bi bi-pencil-square"></i>
                Edit Title
              </a>
              @if (isAdmin) {
                <button (click)="onDeleteTitle()" class="btn btn-danger">
                  <i class="bi bi-trash"></i>
                  Delete Title
                </button>
              }
            </div>
          </div>
        </div>
      }

      <!-- Back Button -->
      <div class="row mt-4">
        <div class="col-12">
          <a routerLink="/titles" class="btn btn-outline-light">
            <i class="bi bi-arrow-left"></i>
            Back to Titles
          </a>
        </div>
      </div>
    }
  </div>
</div>