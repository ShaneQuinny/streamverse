<div class="title-detail-container">
  <div class="container">
    @if (isLoading) {
      <div class="loading">
        <div class="spinner-border text-light"></div>
        <p class="text-white mt-3">Loading...</p>
      </div>
    }
    @if (errorMessage) {
      <div class="alert alert-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>{{ errorMessage }}</div>
    }
    @if (title && !isLoading) {
      <div class="row mb-4">
        <div class="col-lg-8">
          <div class="info-box">
            @if (!isEditingTitle) {
              <span class="badge bg-primary mb-3">{{ title.type }}</span>
              <h1 class="title">{{ title.title }}</h1>
              <div class="meta mb-3">
                <span><i class="bi bi-calendar3"></i> {{ title.release_year }}</span>
                <span>•</span>
                <span><i class="bi bi-clock"></i> {{ title.duration_in_mins }}min</span>
                <span>•</span>
                <span class="badge bg-primary">{{ title.rating }}</span>
              </div>
              <div class="genres mb-3">
                @for (genre of title.genres; track genre) {
                  <span class="genre">{{ genre }}</span>
                }
              </div>
              <div class="ratings mb-4">
                <div><strong>IMDb:</strong> {{ title.imdb_rating }}/10</div>
                <div><strong>Rotten Tomatoes:</strong> {{ title.rotten_tomatoes_score }}%</div>
              </div>
              <div class="description mb-3">
                <h5>Overview</h5>
                <p>{{ title.description }}</p>
              </div>
              @if (title.cast?.length) {
                <div class="description mb-3">
                  <h5>Cast</h5>
                  <p>{{ title.cast.join(', ') }}</p>
                </div>
              }
              @if (title.directors?.length) {
                <div class="description mb-3">
                  <h5>Directors</h5>
                  <p>{{ title.directors.join(', ') }}</p>
                </div>
              }
              @if (title.languages?.length) {
                <div class="description mb-3">
                  <h5>Languages</h5>
                  <p>{{ title.languages.join(', ') }}</p>
                </div>
              }
            } @else {
              <form [formGroup]="titleEditForm">
                <div class="mb-3">
                  <label class="form-label text-white">Type</label>
                  <select class="form-control" formControlName="type">
                    <option value="Movie">Movie</option>
                    <option value="TV Show">TV Show</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label text-white">Title</label>
                  <input type="text" class="form-control" formControlName="title">
                  @if (titleEditForm.get('title')?.invalid && titleEditForm.get('title')?.touched) {
                    <small class="text-danger">Title is required</small>
                  }
                </div>
                <div class="mb-3">
                  <label class="form-label text-white">Cast</label>
                  <div formArrayName="cast">
                    @for (actor of cast.controls; track $index) {
                      <div class="d-flex gap-2 mb-2">
                        <input type="text" class="form-control" [formControlName]="$index">
                        <button type="button" class="btn btn-danger btn-sm" (click)="removeCast($index)">Delete</button>
                      </div>
                    }
                  </div>
                  <button type="button" class="btn btn-outline-light btn-sm mt-2" (click)="addCast()"><i class="bi bi-plus-circle"></i> Add Cast Member</button>
                </div>
                <div class="mb-3">
                  <label class="form-label text-white">Directors</label>
                  <div formArrayName="directors">
                    @for (director of directors.controls; track $index) {
                      <div class="d-flex gap-2 mb-2">
                        <input type="text" class="form-control" [formControlName]="$index">
                        <button type="button" class="btn btn-danger btn-sm" (click)="removeDirector($index)">Delete</button>
                      </div>
                    }
                  </div>
                  <button type="button" class="btn btn-outline-light btn-sm mt-2" (click)="addDirector()"><i class="bi bi-plus-circle"></i> Add Director</button>
                </div>
                <div class="mb-3">
                  <label class="form-label text-white">Languages</label>
                  <div formArrayName="languages">
                    @for (language of languages.controls; track $index) {
                      <div class="d-flex gap-2 mb-2">
                        <input type="text" class="form-control" [formControlName]="$index">
                        <button type="button" class="btn btn-danger btn-sm" (click)="removeLanguage($index)">Delete</button>
                      </div>
                    }
                  </div>
                  <button type="button" class="btn btn-outline-light btn-sm mt-2" (click)="addLanguage()"><i class="bi bi-plus-circle"></i> Add Language</button>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label text-white">Release Year</label>
                    <input type="number" class="form-control" formControlName="release_year">
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label text-white">Duration (mins)</label>
                    <input type="number" class="form-control" formControlName="duration_in_mins">
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label text-white">Rating</label>
                    <select class="form-control" formControlName="rating">
                      <option value="G">G</option>
                      <option value="PG">PG</option>
                      <option value="PG-13">PG-13</option>
                      <option value="R">R</option>
                      <option value="NC-17">NC-17</option>
                      <option value="TV-Y">TV-Y</option>
                      <option value="TV-Y7">TV-Y7</option>
                      <option value="TV-G">TV-G</option>
                      <option value="TV-PG">TV-PG</option>
                      <option value="TV-14">TV-14</option>
                      <option value="TV-MA">TV-MA</option>
                    </select>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label text-white">Genres</label>
                  <div formArrayName="genres">
                    @for (genre of genres.controls; track $index) {
                      <div class="d-flex gap-2 mb-2">
                        <input type="text" class="form-control" [formControlName]="$index">
                        <button type="button" class="btn btn-danger btn-sm" (click)="removeGenre($index)">Delete</button>
                      </div>
                    }
                  </div>
                  <button type="button" class="btn btn-outline-light btn-sm mt-2" (click)="addGenre()"><i class="bi bi-plus-circle"></i> Add Genre</button>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label text-white">IMDb Rating</label>
                    <input type="number" class="form-control" formControlName="imdb_rating" step="0.1" min="0" max="10">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label text-white">Rotten Tomatoes Score</label>
                    <input type="number" class="form-control" formControlName="rotten_tomatoes_score" min="0" max="100">
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label text-white">Description</label>
                  <textarea class="form-control" formControlName="description" rows="4"></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label text-white">Available On</label>
                  <div formArrayName="available_on">
                    @for (platform of availableOn.controls; track $index) {
                      <div [formGroupName]="$index" class="d-flex gap-2 mb-2">
                        <input type="text" class="form-control" formControlName="platform" placeholder="Platform name">
                        <input type="url" class="form-control" formControlName="url" placeholder="URL">
                        <button type="button" class="btn btn-danger btn-sm" (click)="removePlatform($index)">Delete</button>
                      </div>
                    }
                  </div>
                  <button type="button" class="btn btn-outline-light btn-sm mt-2" (click)="addPlatform()"><i class="bi bi-plus-circle"></i> Add Platform</button>
                </div>
              </form>
            }
          </div>
        </div>
        <div class="col-lg-4">
          <div class="poster mb-4">
            <div class="poster-img" [style.background]="getPosterUrl(title) ? 'url(' + getPosterUrl(title) + ') center/cover' : 'linear-gradient(135deg, #0093E9 0%, #80D0C7 100%)'">
              @if (!getPosterUrl(title)) {
                <div class="no-poster">
                  <i class="bi" [class]="title.type === 'Movie' ? 'bi-film' : 'bi-tv'"></i>
                  <span>No Poster</span>
                </div>
              }
            </div>
          </div>
          @if (!isEditingTitle) {
            <div class="platforms-box">
              <h5><i class="bi bi-play-btn-fill"></i> Where to Watch</h5>
              @for (platform of title.available_on; track platform.platform) {
                <a [href]="platform.url" target="_blank" class="platform"><i class="bi bi-play-circle-fill"></i><span>{{ platform.platform }}</span><i class="bi bi-arrow-up-right-circle"></i></a>
              }
              @if (title.available_on.length === 0) {
                <div class="no-data"><i class="bi bi-exclamation-circle"></i><span>Coming soon</span></div>
              }
            </div>
          }
        </div>
      </div>
      @if (currentUsername) {
        <div class="edit-controls mb-4">
          @if (!isEditingTitle) {
            <button (click)="toggleEditMode()" class="btn btn-warning"><i class="bi bi-pencil-square"></i> Edit Title</button>
          } @else {
            <button (click)="onSaveTitleEdit()" class="btn btn-success" [disabled]="titleEditForm.invalid || isSavingTitle"><i class="bi bi-check-circle"></i> {{ isSavingTitle ? 'Saving...' : 'Save Changes' }}</button>
            <button (click)="toggleEditMode()" class="btn btn-secondary" [disabled]="isSavingTitle"><i class="bi bi-x-circle"></i> Cancel</button>
          }
          @if (isAdmin && !isEditingTitle) {
            <button (click)="onDeleteTitle()" class="btn btn-danger"><i class="bi bi-trash"></i> Delete Title</button>
          }
        </div>
      }
      @if (!isEditingTitle) {
        <div class="section mb-4">
          <h3><i class="bi bi-stars"></i> Recommendations based on "{{ title.title }}"</h3>
          @if (recommendationsLoading) {
            <p class="text-white-50">Loading recommendations...</p>
          }
          @else if (recommendationsError) {
            <div class="alert alert-warning py-2">{{ recommendationsError }}</div>
          }
          @else if (recommendedTitles.length > 0) {
            <div class="row g-3">
              @for (rec of recommendedTitles; track rec._id ?? rec.title) {
                <div class="col-lg-3 col-md-4 col-sm-6">
                  <div class="rec-card" (click)="navigateToTitle(rec._id)">
                    <div class="rec-title">{{ rec.title }}</div>
                    <div class="rec-info">
                      <span><i class="bi bi-star-fill"></i> {{ rec.imdb_rating }}/10</span>
                      @if (rec.genres?.length) {
                        <span>{{ rec.genres[0] }}</span>
                      }
                    </div>
                    @if (rec.cast?.length) {
                      <div class="rec-cast">{{ rec.cast.slice(0, 2).join(', ') }}</div>
                    }
                  </div>
                </div>
              }
            </div>
          }
          @else {
            <p class="text-white-50">No recommendations yet.</p>
          }
        </div>
      }
      @if (!isEditingTitle) {
        <div class="section">
          <h3><i class="bi bi-chat-square-text"></i> User Reviews</h3>
          @if (currentUsername) {
            <div class="review-form mb-5">
              <h5>{{ editingReviewId ? 'Edit Review' : 'Write a Review' }}</h5>
              <form [formGroup]="reviewForm" (ngSubmit)="onSubmitReview()">
                <div class="mb-3">
                  <label>Username</label>
                  <input type="text" class="form-control" formControlName="username" readonly />
                </div>
                <div class="mb-4">
                  <label class="mb-3">Rate this title</label>
                  <div>
                    @for (n of [1,2,3,4,5]; track n) {
                      <span (click)="reviewForm.get('rating')?.setValue(n)" style="cursor: pointer; display: inline-block; margin-right: 4px;"><img src="images/star.png" alt="Star" style="width: 24px; height: 24px;" [style.opacity]="n <= (reviewForm.get('rating')?.value || 0) ? 1 : 0.25" /></span>
                    }
                  </div>
                  <div class="rating-display mt-1">
                    <span class="rating-num">{{ reviewForm.get('rating')?.value || 0 }}</span>
                    <span> out of 5 stars</span>
                  </div>
                </div>
                <div class="mb-3">
                  <label>Comment</label>
                  <textarea class="form-control" formControlName="comment" rows="4" placeholder="Share your thoughts..."></textarea>
                  @if (reviewForm.get('comment')?.invalid && reviewForm.get('comment')?.touched) {
                    <small class="text-danger">Comment is required</small>
                  }
                </div>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary" [disabled]="reviewForm.invalid"><i class="bi bi-send"></i> {{ editingReviewId ? 'Update' : 'Submit' }}</button>
                  @if (editingReviewId) {
                    <button type="button" class="btn btn-secondary" (click)="cancelEdit()"><i class="bi bi-x-circle"></i> Cancel</button>
                  }
                </div>
              </form>
            </div>
          }
          @else {
            <div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>Please log in to write a review.</div>
          }
          <div class="row mt-4">
            <div class="col-sm-12">
              @if (reviews$ | async; as reviews) {
                @if (reviews.length > 0) {
                  @for (review of reviews; track review._id) {
                    <div class="card bg-dark text-white mb-3 border-secondary">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <div><i class="bi bi-person-circle me-2"></i>{{ review.username }}</div>
                        @if (currentUsername === review.username || isAdmin) {
                          <div class="d-flex gap-2">
                            @if (currentUsername === review.username) {
                              <button class="btn btn-sm btn-outline-warning" (click)="onEditReview(review)"><i class="bi bi-pencil"></i> Edit</button>
                            }
                            @if (isAdmin) {
                              <button class="btn btn-sm btn-outline-danger" (click)="onDeleteReview(review._id)"><i class="bi bi-trash"></i> Delete</button>
                            }
                          </div>
                        }
                      </div>
                      <div class="card-body">
                        <p class="card-text mb-0">{{ review.comment }}</p>
                      </div>
                      <div class="card-footer d-flex align-items-center gap-2">
                        <div>
                          @for (n of [1,2,3,4,5]; track n) {
                            <img src="images/star.png" alt="Star" style="width: 18px; height: 18px; margin-right: 2px;" [style.opacity]="n <= (review.rating || 0) ? 1 : 0.25" />
                          }
                        </div>
                        <span class="text-muted">{{ review.rating || 0 }}/5</span>
                      </div>
                    </div>
                  }
                }
                @else {
                  <div class="text-center py-5 text-white-50">
                    <i class="bi bi-chat-square-dots fs-1"></i>
                    <p>No reviews yet. Be the first!</p>
                  </div>
                }
              }
            </div>
          </div>
        </div>
      }
      <div class="mt-4">
        <a routerLink="/titles" class="btn btn-outline-light"><i class="bi bi-arrow-left"></i> Back to Titles</a>
      </div>
    }
  </div>
</div>